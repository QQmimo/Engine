(()=>{"use strict";class t{constructor(e){this.onDestroy=t=>{this._onDestroy=t},this.addTags=(...t)=>{t.forEach((t=>{this.compareTag(t)||this.Tags.push(t)}))},this.compareTag=t=>void 0!==this.Tags.find((e=>e===t)),this.destroy=()=>{t.destroy(this.Name),this._onDestroy&&this._onDestroy()},this.Name=e,this.Tags=[],t.add(this)}get Childs(){return Array.from(t.BaseObjects,(([t,e])=>e)).filter((t=>t.Parent===this))}set Name(e){if(t.find(e))throw new Error(`ОШИБКА: ${this.constructor.name} с именем '${e}' уже существует.`);this._Name=e}get Name(){return this._Name}static add(e){if(t.find(e.Name))throw new Error(`ОШИБКА: ${this.name} с именем '${e.Name}' уже существует.`);this.BaseObjects.set(e.Name,e)}static find(t){return this.BaseObjects.get(t)}static findByTag(t){return Array.from(this.BaseObjects,(([t,e])=>e)).filter((e=>this.name===e.constructor.name&&e.compareTag(t)))}static findAll(){return Array.from(this.BaseObjects,(([t,e])=>e)).filter((t=>this.name===t.constructor.name))}static destroy(t){this.BaseObjects.delete(t)}}t.BaseObjects=new Map;class e extends t{constructor(t,e){super(t),this.IsHidden=!1,this.addObject=t=>{t.setLayer(this)},this.update=()=>{this.Childs.forEach((t=>{t.broadcast&&!1===this.IsHidden&&t.broadcast("update")}))},this.Parent=e,this.Context=e.Context}get Childs(){return super.Childs}get Scene(){return this.Parent}get Order(){return this._Order}set Order(t){this._Order=t,this.Parent.sortLayers()}}class s extends t{constructor(s,i){super(s),this.addLayer=t=>{const s=new e(t,this);return s.Order=this.Childs.length,s},this.sortLayers=()=>{t.BaseObjects=new Map(Array.from(t.BaseObjects,(([t,e])=>e)).sort(((t,s)=>t instanceof e&&s instanceof e?t.Order>s.Order?1:t.Order<s.Order?-1:0:0)).map((t=>[t.Name,t])))},this.update=()=>{this.Childs.forEach((t=>{t.update()}))},this.Parent=i,this.Context=i.Context,this._IsActive=!0}get Childs(){return super.Childs}get Screen(){return this.Parent}get IsActive(){return this._IsActive}set IsActive(t){this._IsActive=t}get Order(){return this._Order}set Order(t){this._Order=t,this.Parent.sortScenes()}}class i{constructor(t){this.rotateByPoint=t=>(this.RadianAngle=-Math.atan2(t.Y-this.Center.Y,t.X-this.Center.X),this.RadianAngle),this.rotateByDegree=t=>(this.RadianAngle=t*Math.PI/180,this.RadianAngle),this.rotateByRadian=t=>(this.RadianAngle=t,this.RadianAngle),this.setCenter=t=>{this.Center=t},this.RadianAngle=0,this.Center=t}get DegreeAngle(){return 180*this.RadianAngle/Math.PI}}class n{constructor(){this.Position={X:0,Y:0},this.Rotation=new i(this.Position),this.Scale=1}get Position(){return this._Position}set Position(t){var e;this._Position=t,null===(e=this.Rotation)||void 0===e||e.setCenter(this._Position)}}class o extends t{constructor(t,...e){super(t),this.addComponent=t=>{const e=new t(this);return this.Components.set(t.name,e),e},this.getComponent=t=>{const e=this.Components.get(t.name);if(void 0===e)throw new Error(`ОШИБКА: Компонент '${t.name}' не найден.`);return e},this.tryGetComponent=t=>this.Components.get(t.name),this.detachComponent=t=>{this.Components.delete(t.name)},this.broadcast=(t,...e)=>{Array.from(this.Components,(([t,e])=>e)).filter((e=>e[t]&&"function"==typeof e[t])).forEach((s=>{if(s[t].length!==e.length)throw new Error(`ОШИБКА: Метод '${t}' в компоненте '${s.constructor.name}' количество переданных аргументов (${e.length}) не соответствует ожидаемому (${s[t].length})`);try{s[t].apply(this,...e)}catch(i){throw new Error(`ОШИБКА: Компонент '${s.constructor.name}' не смог запустить метод '${t}' со следующими аргументами: ${e.map((t=>"number"==typeof t?t:`'${t}'`)).join(", ")}.\n${i.message}`)}}))},this.setLayer=t=>{this.Layer=t,this.Parent=t},this.Components=new Map,this.Tags=[],this.IsHidden=!1,this.Transform=new n,e.forEach((t=>{this.addComponent(t)}))}static find(t){return super.find(t)}static findAll(){return super.findAll()}static findByTag(t){return super.findByTag(t)}static findByComponent(t){return Array.from(super.BaseObjects,(([t,e])=>e)).filter((e=>e instanceof o&&e.tryGetComponent(t)))}}class a{constructor(t){this.GameObject=t}}class r extends a{constructor(){super(...arguments),this._Dots=[],this.Opacity=1,this.drawByDots=(...t)=>{this._Radius=void 0,this._Dots=t,this._drawAction=()=>{if(this.GameObject.Layer&&!this.GameObject.IsHidden){this.GameObject.Layer.Context.beginPath(),this.GameObject.Layer.Context.globalAlpha=this.Opacity;const e=this.GameObject.Transform.Position.X,s=this.GameObject.Transform.Position.Y,i=this.GameObject.Transform.Rotation.RadianAngle;this._Dots.forEach(((n,o,a)=>{const r=n.X+e,h=n.Y+s,c=Math.cos(i),d=Math.sin(i);if(0===o?this.GameObject.Layer.Context.moveTo(c*(r-e)+d*(h-s)+e,c*(h-s)-d*(r-e)+s):this.GameObject.Layer.Context.lineTo(c*(r-e)+d*(h-s)+e,c*(h-s)-d*(r-e)+s),o===t.length-1){const t=a[0].X+e,i=a[0].Y+s;this.GameObject.Layer.Context.lineTo(c*(t-e)+d*(i-s)+e,c*(i-s)-d*(t-e)+s)}})),this.GameObject.Layer.Context.setLineDash(this.StrokeDashTemplate||[]),this.GameObject.Layer.Context.strokeStyle=this.StrokeColor,this.GameObject.Layer.Context.lineWidth=this.StrokeWidth,this.GameObject.Layer.Context.stroke(),this.GameObject.Layer.Context.fillStyle=this.BackgroundColor,this.GameObject.Layer.Context.fill(),this.GameObject.Layer.Context.closePath()}}},this.drawByDotsCount=(t,e)=>{const s=[];for(let i=0;i<t;i++){const n=360/t*(Math.PI/180)*i,o=this.GameObject.Transform.Position.X,a=this.GameObject.Transform.Position.Y,r=o+e,h=a,c=Math.cos(n),d=Math.sin(n);s.push({X:c*(r-o)+d*(h-a),Y:c*(h-a)-d*(r-o)})}this.drawByDots(...s)},this.setStroke=(t,e="black")=>{this.StrokeWidth=t,this.StrokeColor=e},this.setStrokeDash=t=>{this.StrokeDashTemplate=t},this.getStrokeWidth=()=>this.StrokeWidth,this.getStrokeColor=()=>this.StrokeColor,this.drawCircle=t=>{this._Radius=t,this._drawAction=()=>{if(this.GameObject.Layer&&!this.GameObject.IsHidden){this.GameObject.Layer.Context.beginPath(),this.GameObject.Layer.Context.globalAlpha=this.Opacity;const e=this.GameObject.Transform.Position.X,s=this.GameObject.Transform.Position.Y;this.GameObject.Layer.Context.arc(e,s,t,this.GameObject.Transform.Rotation.RadianAngle,2*Math.PI+this.GameObject.Transform.Rotation.RadianAngle),this.StrokeColor&&(this.GameObject.Layer.Context.setLineDash(this.StrokeDashTemplate||[]),this.GameObject.Layer.Context.strokeStyle=this.StrokeColor,this.GameObject.Layer.Context.lineWidth=this.StrokeWidth,this.GameObject.Layer.Context.stroke()),this.BackgroundColor&&(this.GameObject.Layer.Context.fillStyle=this.BackgroundColor,this.GameObject.Layer.Context.fill()),this.GameObject.Layer.Context.closePath()}}},this.drawLineTo=t=>{this._Radius=void 0,this._Dots=[this.GameObject.Transform.Position,t],this._drawAction=()=>{this.GameObject.Layer&&!this.GameObject.IsHidden&&(this.GameObject.Layer.Context.beginPath(),this.GameObject.Layer.Context.globalAlpha=this.Opacity,this.GameObject.Layer.Context.moveTo(this.GameObject.Transform.Position.X,this.GameObject.Transform.Position.Y),this.GameObject.Layer.Context.lineTo(t.X,t.Y),this.StrokeColor&&(this.GameObject.Layer.Context.setLineDash(this.StrokeDashTemplate||[]),this.GameObject.Layer.Context.strokeStyle=this.StrokeColor,this.GameObject.Layer.Context.lineWidth=this.StrokeWidth,this.GameObject.Layer.Context.stroke()))}},this.setBackground=t=>{this.BackgroundColor=t},this.getBackground=()=>this.BackgroundColor,this.setOpacity=(t=1)=>{this.Opacity=t},this.getOpacity=()=>this.Opacity,this.getDots=()=>this._Dots.map((t=>({X:t.X+this.GameObject.Transform.Position.X,Y:t.Y+this.GameObject.Transform.Position.Y}))),this.getRadius=()=>this._Radius,this.update=()=>{void 0!==this._drawAction&&this._drawAction()}}}class h extends a{constructor(){super(...arguments),this._IsMoving=!1,this.Speed=1,this.Angle=0,this._move=()=>{if(void 0!==this.Target&&this.Target.X!==this.GameObject.Transform.Position.X&&this.Target.Y!==this.GameObject.Transform.Position.Y){this.Angle=Math.atan2(this.Target.Y-this.GameObject.Transform.Position.Y,this.Target.X-this.GameObject.Transform.Position.X),this._onStart&&!1===this._IsMoving&&this._onStart(this,this.GameObject,this.Target),this._IsMoving=!0;const t=Math.cos(this.Angle)*this.Speed,e=Math.sin(this.Angle)*this.Speed;this.GameObject.Transform.Position.X+=t,this.GameObject.Transform.Position.Y+=e,Math.abs(this.GameObject.Transform.Position.X-this.Target.X)<t&&(this.GameObject.Transform.Position.X=this.Target.X),Math.abs(this.GameObject.Transform.Position.Y-this.Target.Y)<e&&(this.GameObject.Transform.Position.Y=this.Target.Y),this._onMove&&this._onMove(this,this.GameObject,this.Target)}else void 0!==this.Target&&this._onFinish&&(this.Target=void 0,this._IsMoving=!1,this._onFinish(this,this.GameObject))},this.moveTo=t=>{this.Target=t},this.onMove=t=>{this._onMove=t},this.onFinish=t=>{this._onFinish=t},this.onStart=t=>{this._onStart=t},this.stop=(t=!0)=>{this.Target=void 0,this._IsMoving=!1,this._onFinish&&t&&this._onFinish(this,this.GameObject)},this.update=()=>{this._move()}}}class c extends a{constructor(){super(...arguments),this.List=new Map,this.set=(t,e)=>{this.List.set(t,e)},this.get=t=>this.List.get(t),this.delete=t=>{this.List.delete(t)}}}var d;!function(t){t.White="#fff",t.Black="#000",t.Red="#f00",t.Green="#0f0",t.Blue="#00f"}(d||(d={}));class m{}m.Integer=(t=0,e=1)=>Math.floor(m.Float(t,e)),m.Float=(t=0,e=1)=>Math.random()*(e-t+1)+t,m.Color=()=>`rgb(${m.Integer(0,255)}, ${m.Integer(0,255)}, ${m.Integer(0,255)})`,m.Boolean=()=>1===m.Integer(0,1);class l{}l.solve=(t,e={X:0,Y:0})=>Math.sqrt(Math.pow(e.X-t.X,2)+Math.pow(e.Y-t.Y,2));class u{constructor(t,e){this.add=t=>new u(this.Value.X+t.Value.X,this.Value.Y+t.Value.Y),this.sub=t=>new u(this.Value.X-t.Value.X,this.Value.Y-t.Value.Y),this.dot=t=>new u(this.Value.X*t,this.Value.Y*t),this.invert=()=>this.dot(-1),this.multiply=t=>[this.Value.X*t.Value.X,this.Value.Y*t.Value.Y].reduce(((t,e)=>t+e),0),this.length=()=>Math.sqrt(Math.pow(this.Value.X,2)+Math.pow(this.Value.Y||0,2)),this.perpendicular=()=>new u(this.Value.Y,-this.Value.X),this.Value="number"==typeof t&&"number"==typeof e?{X:t,Y:e}:{X:e?e.X-t.X:t.X,Y:e?e.Y-t.Y:t.Y}}}class g{constructor(){this.add=t=>{this.Points.push(t)},this.calculateDirection=()=>{const t=this.Points[this.Points.length-1],e=t.invert();if(3===this.Points.length){const s=this.Points[1],i=this.Points[0],n=s.sub(t),o=i.sub(t);let a=n.perpendicular();if(a.multiply(i)>=0&&(a=a.invert()),a.multiply(e)>0)return this.Points.splice(0,1),a;let r=o.perpendicular();return r.multiply(s)>=0&&(r=r.invert()),r.multiply(e)>0?(this.Points.splice(1,1),r):void 0}let s=this.Points[0].sub(t).perpendicular();return s.multiply(e)<=0&&(s=s.invert()),s},this.Points=[]}}class p extends a{constructor(){super(...arguments),this.update=()=>{o.findByComponent(p).filter((t=>t.Name!==this.GameObject.Name)).forEach((t=>{p.check(this.GameObject,t)&&this._onCollision&&this._onCollision(this.GameObject,t)}))},this.onCollision=t=>{this._onCollision=t}}static _farthestPoint(t,e){let s,i={X:0,Y:0},n=t.getComponent(r);for(const t of n.getDots()){const n=e.multiply(new u(t));(!s||s<n)&&(i=t,s=n)}return new u(i)}static _support(t,e,s){const i=this._farthestPoint(t,s),n=this._farthestPoint(e,s.invert());return i.sub(n)}static check(t,e){const s=new g;let i=new u(0,1);const n=p._support(t,e,i);for(s.add(n),i=i.invert();i;){const n=p._support(t,e,i);if(n.multiply(i)<=0)return!1;s.add(n),i=s.calculateDirection()}return!0}}const f=new class extends t{constructor(e,i,n){super("GameScreen"),this._resizeCanvas=()=>{this.Canvas.width=innerWidth,this.Canvas.height=innerHeight,this.Canvas.style.cssText="position: absolute; top: 0; left: 0;"},this.addScene=t=>{const e=new s(t,this);return e.Order=this.Childs.length,e},this.removeScene=t=>{var e;null===(e=s.find(t))||void 0===e||e.destroy()},this.update=()=>{this.Context.clearRect(0,0,this.Canvas.width,this.Canvas.height),this.Childs.filter((t=>t.IsActive)).forEach((t=>{this.Context.setTransform(1,0,0,1,0,0),t.update(),this.Context.restore()}))},this.sortScenes=()=>{t.BaseObjects=new Map(Array.from(t.BaseObjects,(([t,e])=>e)).sort(((t,e)=>t instanceof s&&e instanceof s?t.Order>e.Order?1:t.Order<e.Order?-1:0:0)).map((t=>[t.Name,t])))},this.play=()=>{this.update(),this.Loop=requestAnimationFrame(this.play)},this.pause=()=>{cancelAnimationFrame(this.Loop)},this.Canvas=document.createElement("canvas"),this.Context=this.Canvas.getContext("2d"),void 0===i||void 0===n||null===i||null===n?(this._resizeCanvas(),window.addEventListener("resize",(t=>{this._resizeCanvas()}))):(this.Canvas.width=i,this.Canvas.height=n),e.appendChild(this.Canvas)}get Childs(){return super.Childs}}(document.body),C=f.addScene("game"),b=C.addLayer("interface"),O=C.addLayer("world");for(let t=0;t<50;t++){const e={X:m.Integer(innerWidth),Y:m.Integer(innerHeight)},s=new o(`obj_${t}`,r,h,p,c);s.Transform.Position={X:m.Integer(innerWidth),Y:m.Integer(innerHeight)};const i=new o(`dot_${s.Name}`,r),n=new o(`line_${s.Name}`,r);n.getComponent(r).drawLineTo(e),n.getComponent(r).setStroke(1),n.getComponent(r).setStrokeDash([5,3]),n.getComponent(r).setOpacity(.35),b.addObject(i),b.addObject(n);const a=s.getComponent(r);a.drawByDotsCount(m.Integer(3,10),m.Integer(10,25)),a.setBackground("green"),a.setStroke(1);const d=s.getComponent(h);d.Speed=1,d.moveTo(e),d.onStart(((t,e,s)=>{e.Transform.Rotation.rotateByPoint(s),setTimeout((()=>{e.getComponent(r).setStroke(1),e.getComponent(r).setBackground("green")}),100);const i=o.find(`dot_${e.Name}`);i&&(i.getComponent(r).drawCircle(5),i.getComponent(r).setBackground("black"),i.Transform.Position=s);const n=o.find(`line_${e.Name}`);n&&n.getComponent(r).drawLineTo(s)})),d.onMove(((t,e,s)=>{const i=o.find(`line_${e.Name}`);i&&(i.Transform.Position=e.Transform.Position)})),d.onFinish(((t,e)=>{const s={X:m.Integer(innerWidth),Y:m.Integer(innerHeight)};t.moveTo(s),o.find(`dot_${e.Name}`).Transform.Position=s})),s.getComponent(p).onCollision(((t,e)=>{t.getComponent(h).stop(!1),t.getComponent(r).setBackground("red");const s=Math.atan2(e.Transform.Position.Y-t.Transform.Position.Y,e.Transform.Position.X-t.Transform.Position.X),i=l.solve(t.Transform.Position,e.Transform.Position),n={X:t.Transform.Position.X-Math.cos(s)*i,Y:t.Transform.Position.Y-Math.sin(s)*i};t.getComponent(h).moveTo(n)})),O.addObject(s)}f.play(),document.body.addEventListener("keypress",(t=>{"Spacebar"!==t.key&&" "!==t.key||!b.IsHidden?"Spacebar"!==t.key&&" "!==t.key||b.IsHidden||(b.IsHidden=!0):b.IsHidden=!1}))})();