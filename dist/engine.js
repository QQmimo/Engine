(()=>{"use strict";class t extends Number{toDegree(){return 180*this.valueOf()/Math.PI}toRadian(){return this.valueOf()}static degree(e){return new t(e*Math.PI/180)}static byPoints(e,n){const i=e instanceof l?e.Transform.Position:e,s=n instanceof l?n.Transform.Position:n;return new t(Math.atan2(s.Y-i.Y,s.X-i.X))}}class e{static Float(t,e){return void 0===e?Math.random()*t:Math.random()*(e-t+1)+t}static Integer(t,n){return Math.floor(e.Float(t,n))}static Color(){return`rgb(${e.Integer(255)}, ${e.Integer(255)}, ${e.Integer(255)})`}static Boolean(){return 1===e.Integer(0,1)}static Angle(n=360){return t.degree(e.Integer(n))}}class n{}n.new=()=>"xxxx-xxxx-xxxx-xxxx".replace(/x/g,(t=>"0123456789ABCDEF".charAt(e.Integer(16))));class i{static solve(t,e){const n=t instanceof l?t.Transform.Position:t,i=e instanceof l?e.Transform.Position:e;return Math.sqrt(Math.pow(i.X-n.X,2)+Math.pow(i.Y-n.Y,2))}}class s{}class o extends s{constructor(t,e){super(),this.X=t,this.Y=e}add(t){return new o(this.X+t.X,this.Y+t.Y)}subtract(t){return new o(this.X-t.X,this.Y-t.Y)}normalize(){const t=this.length();return new o(this.X/t,this.Y/t)}multiply(t){return new o(this.X*t,this.Y*t)}length(){return Math.sqrt(this.X*this.X+this.Y*this.Y)}}class r{constructor(t){this.addTag=t=>{this.Tags.push(t)},this.compareTag=t=>this.Tags.some((e=>e===t)),this.destroy=()=>{r.delete(this.Id),this._onDestroy&&this._onDestroy()},this.onDestroy=t=>{this._onDestroy=t},this.Id=n.new(),this.Tags=[],this.Name=t,r.add(this)}get Childs(){return r.findByParent(this)}set Name(t){this._Name=t}get Name(){return this._Name}static add(t){if(r.findById(t.Id))throw new Error(`ОШИБКА: ${this.name} с идентификатором '${t.Id}' уже существует.`);this.Objects.set(t.Id,t)}static findById(t){return this.Objects.get(t)}static findByName(t){return Array.from(this.Objects,(([t,e])=>e)).find((e=>this.name===e.constructor.name&&e.Name===t))}static findByTag(t){return Array.from(this.Objects,(([t,e])=>e)).filter((e=>this.name===e.constructor.name&&e.compareTag(t)))}static findByParent(t){return Array.from(this.Objects,(([t,e])=>e)).filter((e=>{var n;return(null===(n=e.Parent)||void 0===n?void 0:n.Id)===t.Id}))}static delete(t){this.Objects.delete(t)}}r.Objects=new Map;class a extends r{constructor(t,e){super(e),this.addGameObject=t=>{t.setLayer(this)},this.update=t=>{return e=this,n=void 0,s=function*(){const e=[];this.Childs.forEach((n=>{n.broadcast&&!1===this.IsHidden&&e.push(n.broadcast("update",t))})),yield Promise.all(e)},new((i=void 0)||(i=Promise))((function(t,o){function r(t){try{h(s.next(t))}catch(t){o(t)}}function a(t){try{h(s.throw(t))}catch(t){o(t)}}function h(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(t){t(n)}))).then(r,a)}h((s=s.apply(e,n||[])).next())}));var e,n,i,s},this.Parent=t,this.IsHidden=!1}get Childs(){return super.Childs}set Order(t){this._Order=t,r.Objects=new Map(Array.from(r.Objects,(([t,e])=>e)).sort(((t,e)=>t instanceof a&&e instanceof a?t.Order>e.Order?1:t.Order<e.Order?-1:0:0)).map((t=>[t.Id,t])))}get Order(){return this._Order}get Scene(){return this.Parent}get Screen(){var t;return null===(t=this.Parent)||void 0===t?void 0:t.Screen}get GameObjects(){return this.Childs}static findById(t){return super.findById(t)}static findByName(t){return super.findByName(t)}static findByTag(t){return super.findByTag(t)}static findByParent(t){return super.findByParent(t)}}class h extends r{constructor(t,e){super(e),this.addLayer=t=>{const e=new a(this,t);return e.Order=this.Childs.length,e},this.update=t=>{return e=this,n=void 0,s=function*(){const e=[];this.Childs.forEach((n=>{e.push(n.update(t))})),yield Promise.all(e)},new((i=void 0)||(i=Promise))((function(t,o){function r(t){try{h(s.next(t))}catch(t){o(t)}}function a(t){try{h(s.throw(t))}catch(t){o(t)}}function h(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(t){t(n)}))).then(r,a)}h((s=s.apply(e,n||[])).next())}));var e,n,i,s},this.play=()=>{this.IsPause=!1},this.pause=()=>{this.IsPause=!0},this.Parent=t,this.IsActive=!0,this.IsPause=!1}get Childs(){return super.Childs}get Layers(){return this.Childs}get Screen(){return this.Parent}static findById(t){return this.Objects.get(t)}static findByName(t){return super.findByName(t)}static findByTag(t){return super.findByTag(t)}static findByParent(t){return super.findByParent(t)}}class c{constructor(e){this.Position=new o(0,0),this.Rotation=new t(0),this.Scale=1,this._GameObject=e}rotateToPoint(e){const n=e instanceof l?e.Transform.Position:e;this.Rotation=new t(-t.byPoints(this._GameObject,n).toRadian())}}class l extends r{constructor(t,...e){super(t),this.addComponent=t=>{const e=new t(this);this.Components.set(t.name,e)},this.setLayer=t=>{this.Parent=t},this.broadcast=(t,...e)=>{return n=this,i=void 0,o=function*(){try{const n=[];Array.from(this.Components,(([t,e])=>e)).filter((e=>e[t]&&"function"==typeof e[t])).forEach((i=>{if(i[t].length!==e.length)throw new Error(`ОШИБКА: Метод '${t}' в компоненте '${i.constructor.name}' количество переданных аргументов (${e.length}) не соответствует ожидаемому (${i[t].length})`);n.push(i[t].apply(this,[...e]))})),yield Promise.all(n)}catch(t){console.error(t)}},new((s=void 0)||(s=Promise))((function(t,e){function r(t){try{h(o.next(t))}catch(t){e(t)}}function a(t){try{h(o.throw(t))}catch(t){e(t)}}function h(e){var n;e.done?t(e.value):(n=e.value,n instanceof s?n:new s((function(t){t(n)}))).then(r,a)}h((o=o.apply(n,i||[])).next())}));var n,i,s,o},this.getComponent=t=>{const e=this.Components.get(t.name);if(void 0===e)throw new Error(`ОШИБКА: Компонент '${t.name}' не найден.`);return e},this.tryGetComponent=t=>this.Components.get(t.name),this.detachComponent=t=>{this.Components.delete(t.name)},this.Components=new Map,this.Transform=new c(this),e.forEach((t=>{this.addComponent(t)}))}get Layer(){return this.Parent}get Scene(){var t;return null===(t=this.Parent)||void 0===t?void 0:t.Scene}get Screen(){var t;return null===(t=this.Parent)||void 0===t?void 0:t.Screen}static findById(t){return super.findById(t)}static findByName(t){return super.findByName(t)}static findByTag(t){return super.findByTag(t)}static findByParent(t){return super.findByParent(t)}static findByComponent(t){return Array.from(super.Objects,(([t,e])=>e)).filter((e=>e instanceof l&&e.tryGetComponent(t)))}}class d{constructor(t){this.GameObject=t}get IsPause(){return this.GameObject.Scene.IsPause}}class u extends d{constructor(){super(...arguments),this._MoveAngle=new t(0),this._StartTravell=!1,this.stop=()=>{this.Target=void 0,this._StartTravell=!1,this._onStop&&this._onStop(this.GameObject,this)},this.onStart=t=>{this._onStart=t},this.onStop=t=>{this._onStop=t},this.onFinish=t=>{this._onFinish=t},this.onMove=t=>{this._onMove=t},this.update=e=>{return n=this,i=void 0,o=function*(){var n,i;if(this._onStart&&this.IsMoving&&!this._StartTravell&&(this._StartTravell=!0,this._onStart(this.GameObject,this)),this.GameObject.Transform.Position.X===(null===(n=this.Target)||void 0===n?void 0:n.X)&&this.GameObject.Transform.Position.Y===(null===(i=this.Target)||void 0===i?void 0:i.Y))return this.stop(),void(this._onFinish&&this._onFinish(this.GameObject,this));if(!1===this.IsPause&&this.IsMoving){this._MoveAngle=t.byPoints(this.GameObject,this.Target),this._onMove&&this._onMove(this.GameObject,this);const n=this.Target.subtract(this.GameObject.Transform.Position);if(n.length()<1)return this.stop(),void(this._onFinish&&this._onFinish(this.GameObject,this));const i=n.normalize();this.GameObject.Transform.Position=this.GameObject.Transform.Position.add(i.multiply(this.Speed*e))}},new((s=void 0)||(s=Promise))((function(t,e){function r(t){try{h(o.next(t))}catch(t){e(t)}}function a(t){try{h(o.throw(t))}catch(t){e(t)}}function h(e){var n;e.done?t(e.value):(n=e.value,n instanceof s?n:new s((function(t){t(n)}))).then(r,a)}h((o=o.apply(n,i||[])).next())}));var n,i,s,o}}get MoveAngle(){return this._MoveAngle}get IsMoving(){return void 0!==this.Target}moveTo(t){this.Target=t instanceof l?t.Transform.Position:t}}class m extends d{constructor(){super(...arguments),this._Dots=[],this.IsHidden=!1,this.clearLineStyle=()=>{this._LineStyle={}},this.clearFillStyle=()=>{this._FillStyle={}},this.draw=(...t)=>{var e,n,i,s,o,r,a,h;this._Dots=t,this.GameObject.Layer&&!this.IsHidden&&(this.GameObject.Screen.Context.beginPath(),this._Dots.forEach(((e,n,i)=>{0===n?this.GameObject.Screen.Context.moveTo(e.X+this.GameObject.Transform.Position.X,e.Y+this.GameObject.Transform.Position.Y):this.GameObject.Screen.Context.lineTo(e.X+this.GameObject.Transform.Position.X,e.Y+this.GameObject.Transform.Position.Y),n===t.length-1&&this.GameObject.Screen.Context.lineTo(i[0].X+this.GameObject.Transform.Position.X,i[0].Y+this.GameObject.Transform.Position.Y)})),void 0!==(null===(e=this.LineStyle)||void 0===e?void 0:e.Color)&&0!==(null===(n=this.LineStyle)||void 0===n?void 0:n.Width)&&(this.GameObject.Screen.Context.globalAlpha=(null===(i=this.LineStyle)||void 0===i?void 0:i.Opacity)||1,this.GameObject.Screen.Context.setLineDash((null===(s=this.LineStyle)||void 0===s?void 0:s.Template)||[]),this.GameObject.Screen.Context.lineWidth=null===(o=this.LineStyle)||void 0===o?void 0:o.Width,this.GameObject.Screen.Context.strokeStyle=null===(r=this.LineStyle)||void 0===r?void 0:r.Color,this.GameObject.Screen.Context.stroke()),this.GameObject.Screen.Context.globalAlpha=(null===(a=this.FillStyle)||void 0===a?void 0:a.Opacity)||1,this.GameObject.Screen.Context.fillStyle=null===(h=this.FillStyle)||void 0===h?void 0:h.Color,this.GameObject.Screen.Context.fill(),this.GameObject.Screen.Context.closePath())},this.drawByDotsCount=(e,n)=>{const i=[];for(let s=0;s<e;s++){const r=t.degree(360/e*s+this.GameObject.Transform.Rotation.toDegree()),a=this.GameObject.Transform.Position.X,h=this.GameObject.Transform.Position.Y,c=a+n,l=h,d=Math.cos(r.toRadian()),u=Math.sin(r.toRadian());i.push(new o(d*(c-a)+u*(l-h),d*(l-h)-u*(c-a)))}this.draw(...i)},this.drawLine=(t,e)=>{this.draw(t,e)},this.update=t=>{return e=this,n=void 0,s=function*(){this.draw(...this._Dots)},new((i=void 0)||(i=Promise))((function(t,o){function r(t){try{h(s.next(t))}catch(t){o(t)}}function a(t){try{h(s.throw(t))}catch(t){o(t)}}function h(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(t){t(n)}))).then(r,a)}h((s=s.apply(e,n||[])).next())}));var e,n,i,s}}set LineStyle(t){this._LineStyle=Object.assign(Object.assign({},this._LineStyle),t)}get LineStyle(){return this._LineStyle}set FillStyle(t){this._FillStyle=Object.assign(Object.assign({},this._FillStyle),t)}get FillStyle(){return this._FillStyle}get Dots(){return this._Dots.map((t=>t.add(this.GameObject.Transform.Position)))}}class f extends d{constructor(){super(...arguments),this.Dictionary=new Map}set(t,e){this.Dictionary.set(t,e)}get(t){return this.Dictionary.get(t)}delete(t){this.Dictionary.delete(t)}get allKeys(){return Array.from(this.Dictionary,(([t,e])=>t))}clear(){this.Dictionary.clear()}}class g extends d{constructor(){super(...arguments),this._solveNeighbours=()=>{const t=l.findByComponent(g).filter((t=>t.Id!==this.GameObject.Id)).map((t=>({distance:i.solve(this.GameObject,t),object:t}))).sort(((t,e)=>t.distance>e.distance?1:t.distance<e.distance?-1:0)).filter(((t,e)=>e<this._NeighboursCount)).map((t=>t.object));return this._onNeighboursChange&&this._onNeighboursChange(this.GameObject,t),t},this._NeighboursCount=1,this._Neighbours=[],this.update=t=>{var e,n;null!==(n=null===(e=this.GameObject.tryGetComponent(u))||void 0===e?void 0:e.IsMoving)&&void 0!==n&&n&&this._onCollision&&(this._Neighbours=this._solveNeighbours(),this._Neighbours.forEach((t=>{this.check(this.GameObject,t)&&this._onCollision(this.GameObject,t)})))},this.onCollision=t=>{this._onCollision=t},this.onNeighboursChange=(t,e)=>{this._NeighboursCount=t,this._onNeighboursChange=e}}check(t,e){const n=this._getAxes(t).concat(this._getAxes(e));for(const i of n){const n=this._project(t,i),s=this._project(e,i);if(!this._overlaps(n,s))return!1}return!0}_project(t,e){var n,i;let s=1/0,o=-1/0;for(const r of null!==(i=null===(n=t.tryGetComponent(m))||void 0===n?void 0:n.Dots)&&void 0!==i?i:[]){const t=e.X*r.X+e.Y*r.Y;s=Math.min(s,t),o=Math.max(o,t)}return{min:s,max:o}}_overlaps(t,e){return t.max>=e.min&&e.max>=t.min}_getAxes(t){var e,n;const i=[],s=null!==(n=null===(e=t.tryGetComponent(m))||void 0===e?void 0:e.Dots)&&void 0!==n?n:[];for(let t=0;t<s.length;t++){const e=s[t],n=s[(t+1)%s.length],o={X:n.X-e.X,Y:n.Y-e.Y},r={X:-o.Y,Y:o.X},a=Math.sqrt(Math.pow(r.X,2)+Math.pow(r.Y,2));i.push({X:r.X/a,Y:r.Y/a})}return i}}const p=new class extends r{constructor(t,e,n){super(),this._LastTime=0,this._resizeCanvas=()=>{this.Canvas.width=innerWidth,this.Canvas.height=innerHeight,this.Canvas.style.cssText="position: absolute; top: 0; left: 0;"},this._onShowFps=()=>{const t=performance.now();for(;this._Times.length>0&&this._Times[0]<=t-1e3;)this._Times.shift();return this._Times.push(t),this._Times.length},this.addScene=t=>new h(this,t),this.removeScene=t=>{var e;null===(e=h.findByName(t))||void 0===e||e.destroy()},this.update=t=>{return e=this,n=void 0,s=function*(){const e=[];this.Context.clearRect(0,0,this.Width,this.Height),this.Childs.filter((t=>t.IsActive)).forEach((n=>{this.Context.setTransform(1,0,0,1,0,0),e.push(n.update(t)),this.Context.restore()})),this._IsShowFps&&this.fps(this._IsShowFps),yield Promise.all(e)},new((i=void 0)||(i=Promise))((function(t,o){function r(t){try{h(s.next(t))}catch(t){o(t)}}function a(t){try{h(s.throw(t))}catch(t){o(t)}}function h(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(t){t(n)}))).then(r,a)}h((s=s.apply(e,n||[])).next())}));var e,n,i,s},this.fps=(t=!1)=>{this._IsShowFps=t,this._IsShowFps&&(this.Context.beginPath(),this.Context.globalAlpha=.75,this.Context.fillStyle="black",this.Context.fillRect(10,10,70,24),this.Context.closePath(),this.Context.beginPath(),this.Context.globalAlpha=1,this.Context.textAlign="center",this.Context.strokeStyle="#00fb00",this.Context.textBaseline="middle",this.Context.font="lighter 18px sans-serif",this.Context.moveTo(35,22),this.Context.fillStyle="#00fb00",this.Context.fillText(`FPS: ${this._onShowFps()}`,45,22,70),this.Context.closePath())},this.play=(t=0)=>{const e=(t-this._LastTime)/1e3;this._LastTime=t,this.update(e),this.Loop=requestAnimationFrame(this.play)},this.pause=()=>{cancelAnimationFrame(this.Loop)},this._Times=[],this._IsShowFps=!1,this.Canvas=document.createElement("canvas"),this.Context=this.Canvas.getContext("2d"),void 0===e||void 0===n||null===e||null===n?(this._resizeCanvas(),window.addEventListener("resize",(t=>{this._resizeCanvas()}))):(this.Canvas.width=e,this.Canvas.height=n),t.appendChild(this.Canvas)}get Childs(){return super.Childs}set Name(t){if(r.findByName(t))throw new Error(`ОШИБКА: ${this.constructor.name} с именем '${t}' уже существует.`);super.Name=t}get Name(){return super.Name}get Width(){return this.Canvas.width}get Height(){return this.Canvas.height}get Scenes(){return this.Childs}static findSceneByName(t){return Array.from(this.Objects,(([t,e])=>e)).find((e=>e instanceof h&&e.Name===t))}static findById(t){return super.findById(t)}static findByName(t){return super.findByName(t)}static findByTag(t){return super.findByTag(t)}}(document.body),y=p.addScene("game"),v=y.addLayer("uix"),C=y.addLayer("world"),b=(t,n=10)=>{t.Transform.Rotation=e.Angle(),t.getComponent(f).set("size",n),t.getComponent(m).drawByDotsCount(e.Integer(3,10),n),t.getComponent(u).Speed=e.Integer(5,50),t.getComponent(u).moveTo(new o(e.Integer(innerWidth),e.Integer(innerHeight)))};((t,n=10)=>{for(let i=0;i<t;i++){const t=new l("cube",u,m,g,f);t.Transform.Position=new o(e.Integer(innerWidth),e.Integer(innerHeight)),b(t,e.Integer(5,10)*n),t.getComponent(u).onStart(((t,i)=>{t.Transform.Rotation=e.Angle(),t.getComponent(m).drawByDotsCount(e.Integer(3,10),e.Integer(5,10)*n),t.getComponent(m).FillStyle={Color:"green"}})),t.getComponent(g).onCollision(((t,e)=>{t.getComponent(u).stop(),e.getComponent(u).stop()})),t.getComponent(u).onStop(((t,e)=>{t.getComponent(m).FillStyle={Color:"red"},t.getComponent(f).get("wait")||(t.getComponent(f).set("wait",!0),setTimeout((()=>{const e=t.getComponent(f).get("size");b(t,e-1<1?1:e-1),t.getComponent(f).set("wait",!1)}),2e3))})),t.getComponent(u).onFinish(((t,i)=>{t.getComponent(m).FillStyle={Color:"gray"},setTimeout((()=>{b(t,e.Integer(5,10)*n)}),2e3)})),t.getComponent(u).onMove(((t,e)=>{var n;null===(n=t.getComponent(f).get("line"))||void 0===n||n.destroy();const i=new l("line",m);i.getComponent(m).drawLine(t.Transform.Position,e.Target),i.getComponent(m).LineStyle={Width:2,Color:"lightgray",Template:[5,3]},v.addGameObject(i),t.getComponent(f).set("line",i)})),C.addGameObject(t)}})(25,5),p.fps(!0),p.play()})();