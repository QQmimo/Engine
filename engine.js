(()=>{"use strict";class t extends Number{toDegree(){return 180*this.valueOf()/Math.PI}toRadian(){return this.valueOf()}static degree(e){return new t(e*Math.PI/180)}static byPoints(e,i){const n=e instanceof c?e.Transform.Position:e,s=i instanceof c?i.Transform.Position:i;return new t(Math.atan2(s.Y-n.Y,s.X-n.X))}}class e{static Float(t,e){return void 0===e?Math.random()*t:Math.random()*(e-t+1)+t}static Integer(t,i){return Math.floor(e.Float(t,i))}static Color(){return`rgb(${e.Integer(255)}, ${e.Integer(255)}, ${e.Integer(255)})`}static Boolean(){return 1===e.Integer(0,1)}static Angle(i=360){return t.degree(e.Integer(i))}}class i{}i.new=()=>"xxxx-xxxx-xxxx-xxxx".replace(/x/g,(t=>"0123456789ABCDEF".charAt(e.Integer(16))));class n{static solve(t,e){const i=t instanceof c?t.Transform.Position:t,n=e instanceof c?e.Transform.Position:e;return Math.sqrt(Math.pow(n.X-i.X,2)+Math.pow(n.Y-i.Y,2))}}class s{constructor(t,e){this.add=t=>{var e,i,n,o;return new s(this.Value.X+t.Value.X,(null!==(i=null===(e=this.Value)||void 0===e?void 0:e.Y)&&void 0!==i?i:0)+(null!==(o=null===(n=t.Value)||void 0===n?void 0:n.Y)&&void 0!==o?o:0))},this.sub=t=>{var e,i;return this.add(new s(-t.Value.X,null!==(i=-(null===(e=t.Value)||void 0===e?void 0:e.Y))&&void 0!==i?i:0))},this.invert=()=>this.multyply(-1),this.length=()=>{var t;return Math.sqrt(Math.pow(this.Value.X,2)+Math.pow(null!==(t=this.Value.Y)&&void 0!==t?t:0,2))},this.perpendicular=()=>{var t,e;return new s(null!==(e=null===(t=this.Value)||void 0===t?void 0:t.Y)&&void 0!==e?e:0,-this.Value.X)},this.Value="number"==typeof t&&"number"==typeof e?{X:t,Y:null!=e?e:0}:{X:e?e.X-t.X:t.X,Y:e?e.Y-t.Y:t.Y}}multyply(t){var e,i,n,o,r,a;return"number"==typeof t?new s(this.Value.X*t,(null!==(i=null===(e=this.Value)||void 0===e?void 0:e.Y)&&void 0!==i?i:0)*t):t instanceof s?[this.Value.X*t.Value.X,(null!==(o=null===(n=this.Value)||void 0===n?void 0:n.Y)&&void 0!==o?o:0)*(null!==(a=null===(r=t.Value)||void 0===r?void 0:r.Y)&&void 0!==a?a:0)].reduce(((t,e)=>t+e),0):void 0}}class o{constructor(t){this.addTag=t=>{this.Tags.push(t)},this.compareTag=t=>this.Tags.some((e=>e===t)),this.destroy=()=>{o.delete(this.Id),this._onDestroy&&this._onDestroy()},this.onDestroy=t=>{this._onDestroy=t},this.Id=i.new(),this.Tags=[],this.Name=t,o.add(this)}get Childs(){return o.findByParent(this)}set Name(t){this._Name=t}get Name(){return this._Name}static add(t){if(o.findById(t.Id))throw new Error(`ОШИБКА: ${this.name} с идентификатором '${t.Id}' уже существует.`);this.Objects.set(t.Id,t)}static findById(t){return this.Objects.get(t)}static findByName(t){return Array.from(this.Objects,(([t,e])=>e)).find((e=>this.name===e.constructor.name&&e.Name===t))}static findByTag(t){return Array.from(this.Objects,(([t,e])=>e)).filter((e=>this.name===e.constructor.name&&e.compareTag(t)))}static findByParent(t){return Array.from(this.Objects,(([t,e])=>e)).filter((e=>{var i;return(null===(i=e.Parent)||void 0===i?void 0:i.Id)===t.Id}))}static delete(t){this.Objects.delete(t)}}o.Objects=new Map;class r extends o{constructor(t,e){super(e),this.addGameObject=t=>{t.setLayer(this)},this.update=()=>{return t=this,e=void 0,n=function*(){const t=[];this.Childs.forEach((e=>{e.broadcast&&!1===this.IsHidden&&t.push(e.broadcast("update"))})),yield Promise.all(t)},new((i=void 0)||(i=Promise))((function(s,o){function r(t){try{h(n.next(t))}catch(t){o(t)}}function a(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}h((n=n.apply(t,e||[])).next())}));var t,e,i,n},this.Parent=t,this.IsHidden=!1}get Childs(){return super.Childs}set Order(t){this._Order=t,o.Objects=new Map(Array.from(o.Objects,(([t,e])=>e)).sort(((t,e)=>t instanceof r&&e instanceof r?t.Order>e.Order?1:t.Order<e.Order?-1:0:0)).map((t=>[t.Id,t])))}get Order(){return this._Order}get Scene(){return this.Parent}get Screen(){var t;return null===(t=this.Parent)||void 0===t?void 0:t.Screen}get GameObjects(){return this.Childs}static findById(t){return super.findById(t)}static findByName(t){return super.findByName(t)}static findByTag(t){return super.findByTag(t)}static findByParent(t){return super.findByParent(t)}}class a extends o{constructor(t,e){super(e),this.addLayer=t=>{const e=new r(this,t);return e.Order=this.Childs.length,e},this.update=()=>{return t=this,e=void 0,n=function*(){const t=[];this.Childs.forEach((e=>{t.push(e.update())})),yield Promise.all(t)},new((i=void 0)||(i=Promise))((function(s,o){function r(t){try{h(n.next(t))}catch(t){o(t)}}function a(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}h((n=n.apply(t,e||[])).next())}));var t,e,i,n},this.play=()=>{this.IsPause=!1},this.pause=()=>{this.IsPause=!0},this.Parent=t,this.IsActive=!0,this.IsPause=!1}get Childs(){return super.Childs}get Layers(){return this.Childs}get Screen(){return this.Parent}static findById(t){return this.Objects.get(t)}static findByName(t){return super.findByName(t)}static findByTag(t){return super.findByTag(t)}static findByParent(t){return super.findByParent(t)}}class h{constructor(e){this.Position={X:0,Y:0},this.Rotation=new t(0),this.Scale=1,this._GameObject=e}rotateToPoint(e){const i=e instanceof c?e.Transform.Position:e;this.Rotation=new t(-t.byPoints(this._GameObject,i).toRadian())}}class c extends o{constructor(t,...e){super(t),this.addComponent=t=>{const e=new t(this);this.Components.set(t.name,e)},this.setLayer=t=>{this.Parent=t},this.broadcast=(t,...e)=>{return i=this,n=void 0,o=function*(){try{const i=[];Array.from(this.Components,(([t,e])=>e)).filter((e=>e[t]&&"function"==typeof e[t])).forEach((n=>{if(n[t].length!==e.length)throw new Error(`ОШИБКА: Метод '${t}' в компоненте '${n.constructor.name}' количество переданных аргументов (${e.length}) не соответствует ожидаемому (${n[t].length})`);i.push(n[t].apply(this,...e))})),yield Promise.all(i)}catch(t){console.error(t)}},new((s=void 0)||(s=Promise))((function(t,e){function r(t){try{h(o.next(t))}catch(t){e(t)}}function a(t){try{h(o.throw(t))}catch(t){e(t)}}function h(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(r,a)}h((o=o.apply(i,n||[])).next())}));var i,n,s,o},this.getComponent=t=>{const e=this.Components.get(t.name);if(void 0===e)throw new Error(`ОШИБКА: Компонент '${t.name}' не найден.`);return e},this.tryGetComponent=t=>this.Components.get(t.name),this.detachComponent=t=>{this.Components.delete(t.name)},this.Components=new Map,this.Transform=new h(this),e.forEach((t=>{this.addComponent(t)}))}get Layer(){return this.Parent}get Scene(){var t;return null===(t=this.Parent)||void 0===t?void 0:t.Scene}get Screen(){var t;return null===(t=this.Parent)||void 0===t?void 0:t.Screen}static findById(t){return super.findById(t)}static findByName(t){return super.findByName(t)}static findByTag(t){return super.findByTag(t)}static findByParent(t){return super.findByParent(t)}static findByComponent(t){return Array.from(super.Objects,(([t,e])=>e)).filter((e=>e instanceof c&&e.tryGetComponent(t)))}}class l{constructor(t){this.GameObject=t}get IsPause(){return this.GameObject.Scene.IsPause}}class d extends l{constructor(){super(...arguments),this._IsMoving=!1,this._MoveAngle=new t(0),this.Speed=0,this.stop=()=>{this.Target=void 0},this.onStart=t=>{this._onStart=t},this.onFinish=t=>{this._onFinish=t},this.onMove=t=>{this._onMove=t},this.update=()=>{return e=this,i=void 0,s=function*(){if(!1!==this.IsPause||void 0===this.Target||this.Target.X===this.GameObject.Transform.Position.X&&this.Target.Y===this.GameObject.Transform.Position.Y)void 0!==this.Target&&this._onFinish&&(this.Target=void 0,this._IsMoving=!1,this._onFinish(this.GameObject,this));else{this._MoveAngle=t.byPoints(this.GameObject,this.Target),this._onStart&&!1===this._IsMoving&&this._onStart(this.GameObject,this),this._IsMoving=!0;const e=Math.cos(this._MoveAngle.toRadian())*this.Speed,i=Math.sin(this._MoveAngle.toRadian())*this.Speed;this.GameObject.Transform.Position.X+=e,this.GameObject.Transform.Position.Y+=i,Math.abs(this.GameObject.Transform.Position.X-this.Target.X)<e&&(this.GameObject.Transform.Position.X=this.Target.X),Math.abs(this.GameObject.Transform.Position.Y-this.Target.Y)<i&&(this.GameObject.Transform.Position.Y=this.Target.Y),this._onMove&&this._onMove(this.GameObject,this)}},new((n=void 0)||(n=Promise))((function(t,o){function r(t){try{h(s.next(t))}catch(t){o(t)}}function a(t){try{h(s.throw(t))}catch(t){o(t)}}function h(e){var i;e.done?t(e.value):(i=e.value,i instanceof n?i:new n((function(t){t(i)}))).then(r,a)}h((s=s.apply(e,i||[])).next())}));var e,i,n,s}}get MoveAngle(){return this._MoveAngle}get IsMoving(){return this._IsMoving}moveTo(t){this.Target=t instanceof c?t.Transform.Position:t}}class u extends l{constructor(){super(...arguments),this._Dots=[],this.IsHidden=!1,this.clearLineStyle=()=>{this._LineStyle={}},this.clearFillStyle=()=>{this._FillStyle={}},this.draw=(...t)=>{var e,i,n,s,o,r,a,h;if(this._Dots=t,this.GameObject.Layer&&!this.IsHidden){this.GameObject.Screen.Context.beginPath();const c=this.GameObject.Transform.Position.X,l=this.GameObject.Transform.Position.Y,d=this.GameObject.Transform.Rotation.toRadian();this._Dots.forEach(((e,i,n)=>{const s=e.X+c,o=e.Y+l,r=Math.cos(d),a=Math.sin(d);if(0===i?this.GameObject.Screen.Context.moveTo(r*(s-c)+a*(o-l)+c,r*(o-l)-a*(s-c)+l):this.GameObject.Screen.Context.lineTo(r*(s-c)+a*(o-l)+c,r*(o-l)-a*(s-c)+l),i===t.length-1){const t=n[0].X+c,e=n[0].Y+l;this.GameObject.Screen.Context.lineTo(r*(t-c)+a*(e-l)+c,r*(e-l)-a*(t-c)+l)}})),void 0!==(null===(e=this.LineStyle)||void 0===e?void 0:e.Color)&&0!==(null===(i=this.LineStyle)||void 0===i?void 0:i.Width)&&(this.GameObject.Screen.Context.globalAlpha=(null===(n=this.LineStyle)||void 0===n?void 0:n.Opacity)||1,this.GameObject.Screen.Context.setLineDash((null===(s=this.LineStyle)||void 0===s?void 0:s.Template)||[]),this.GameObject.Screen.Context.lineWidth=null===(o=this.LineStyle)||void 0===o?void 0:o.Width,this.GameObject.Screen.Context.strokeStyle=null===(r=this.LineStyle)||void 0===r?void 0:r.Color,this.GameObject.Screen.Context.stroke()),this.GameObject.Screen.Context.globalAlpha=(null===(a=this.FillStyle)||void 0===a?void 0:a.Opacity)||1,this.GameObject.Screen.Context.fillStyle=null===(h=this.FillStyle)||void 0===h?void 0:h.Color,this.GameObject.Screen.Context.fill(),this.GameObject.Screen.Context.closePath()}},this.drawByDotsCount=(e,i)=>{const n=[];for(let s=0;s<e;s++){const o=t.degree(360/e*s),r=this.GameObject.Transform.Position.X,a=this.GameObject.Transform.Position.Y,h=r+i,c=a,l=Math.cos(o.toRadian()),d=Math.sin(o.toRadian());n.push({X:l*(h-r)+d*(c-a),Y:l*(c-a)-d*(h-r)})}this.draw(...n)},this.drawLine=(t,e)=>{this.draw(t,e)},this.update=()=>{return t=this,e=void 0,n=function*(){this.draw(...this._Dots)},new((i=void 0)||(i=Promise))((function(s,o){function r(t){try{h(n.next(t))}catch(t){o(t)}}function a(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}h((n=n.apply(t,e||[])).next())}));var t,e,i,n}}set LineStyle(t){this._LineStyle=Object.assign(Object.assign({},this._LineStyle),t)}get LineStyle(){return this._LineStyle}set FillStyle(t){this._FillStyle=Object.assign(Object.assign({},this._FillStyle),t)}get FillStyle(){return this._FillStyle}get Dots(){return this._Dots.map((t=>({X:t.X+this.GameObject.Transform.Position.X,Y:t.Y+this.GameObject.Transform.Position.Y})))}}class m{constructor(){this.add=t=>{this._Points.push(t)},this.calculateDirection=()=>{const t=this._Points[this._Points.length-1],e=t.invert();if(3===this._Points.length){const i=this._Points[1],n=this._Points[0],s=i.sub(t),o=n.sub(t);let r=s.perpendicular();if(r.multyply(n)>=0&&(r=r.invert()),r.multyply(e)>0)return this._Points.splice(0,1),r;let a=o.perpendicular();return a.multyply(i)>=0&&(a=a.invert()),a.multyply(e)>0?(this._Points.splice(1,1),a):void 0}let i=this._Points[0].sub(t).perpendicular();return i.multyply(e)<=0&&(i=i.invert()),i},this._Points=[]}}class f extends l{constructor(){super(...arguments),this._solveNeighbours=()=>{const t=c.findByComponent(f).filter((t=>t.Id!==this.GameObject.Id)).map((t=>({distance:n.solve(this.GameObject,t),object:t}))).sort(((t,e)=>t.distance>e.distance?1:t.distance<e.distance?-1:0)).filter(((t,e)=>e<this._NeighboursCount)).map((t=>t.object));return this._onNeighboursChange&&this._onNeighboursChange(this.GameObject,t),t},this._NeighboursCount=1,this._Neighbours=[],this.update=()=>{var t,e;this._onCollision&&null!==(e=null===(t=this.GameObject.tryGetComponent(d))||void 0===t?void 0:t.IsMoving)&&void 0!==e&&e&&(this._Neighbours=this._solveNeighbours(),this._Neighbours.forEach((t=>{f.check(this.GameObject,t)&&this._onCollision(this.GameObject,t)})))},this.onCollision=t=>{this._onCollision=t},this.onNeighboursChange=(t,e)=>{this._NeighboursCount=t,this._onNeighboursChange=e}}static _getFarthestPoint(t,e){let i,n={X:0,Y:0};return t.getComponent(u).Dots.forEach((t=>{const o=e.multyply(new s(t));(!i||i<o)&&(n=t,i=o)})),new s(n)}static _getSupportPoint(t,e,i){const n=this._getFarthestPoint(t,i),s=this._getFarthestPoint(e,i);return n.sub(s)}static check(t,e){const i=new m;let n=new s(0,1);const o=this._getSupportPoint(t,e,n);for(i.add(o),n=n.invert();n;){const s=this._getSupportPoint(t,e,n);if(s.multyply(n)<=0)return!1;i.add(s),n=i.calculateDirection()}return!0}}const p=new class extends o{constructor(t,e,i){super(),this._resizeCanvas=()=>{this.Canvas.width=innerWidth,this.Canvas.height=innerHeight,this.Canvas.style.cssText="position: absolute; top: 0; left: 0;"},this._onShowFps=()=>{const t=performance.now();for(;this._Times.length>0&&this._Times[0]<=t-1e3;)this._Times.shift();return this._Times.push(t),this._Times.length},this.addScene=t=>new a(this,t),this.removeScene=t=>{var e;null===(e=a.findByName(t))||void 0===e||e.destroy()},this.update=()=>{return t=this,e=void 0,n=function*(){const t=[];this.Context.clearRect(0,0,this.Width,this.Height),this.Childs.filter((t=>t.IsActive)).forEach((e=>{this.Context.setTransform(1,0,0,1,0,0),t.push(e.update()),this.Context.restore()})),this._IsShowFps&&this.showFps(this._IsShowFps),yield Promise.all(t)},new((i=void 0)||(i=Promise))((function(s,o){function r(t){try{h(n.next(t))}catch(t){o(t)}}function a(t){try{h(n.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(r,a)}h((n=n.apply(t,e||[])).next())}));var t,e,i,n},this.showFps=(t=!1)=>{this._IsShowFps=t,this._IsShowFps&&(this.Context.beginPath(),this.Context.globalAlpha=.75,this.Context.fillStyle="black",this.Context.fillRect(10,10,70,24),this.Context.closePath(),this.Context.beginPath(),this.Context.globalAlpha=1,this.Context.textAlign="center",this.Context.strokeStyle="#00fb00",this.Context.textBaseline="middle",this.Context.font="lighter 18px sans-serif",this.Context.moveTo(35,22),this.Context.fillStyle="#00fb00",this.Context.fillText(`FPS: ${this._onShowFps()}`,45,22,70),this.Context.closePath())},this.play=()=>{this.update(),this.Loop=requestAnimationFrame(this.play)},this.pause=()=>{cancelAnimationFrame(this.Loop)},this._Times=[],this._IsShowFps=!1,this.Canvas=document.createElement("canvas"),this.Context=this.Canvas.getContext("2d"),void 0===e||void 0===i||null===e||null===i?(this._resizeCanvas(),window.addEventListener("resize",(t=>{this._resizeCanvas()}))):(this.Canvas.width=e,this.Canvas.height=i),t.appendChild(this.Canvas)}get Childs(){return super.Childs}set Name(t){if(o.findByName(t))throw new Error(`ОШИБКА: ${this.constructor.name} с именем '${t}' уже существует.`);super.Name=t}get Name(){return super.Name}get Width(){return this.Canvas.width}get Height(){return this.Canvas.height}get Scenes(){return this.Childs}static findSceneByName(t){return Array.from(this.Objects,(([t,e])=>e)).find((e=>e instanceof a&&e.Name===t))}static findById(t){return super.findById(t)}static findByName(t){return super.findByName(t)}static findByTag(t){return super.findByTag(t)}}(document.body),v=p.addScene("game"),g=v.addLayer("world"),y=v.addLayer("interface");((t,i,n)=>{for(let t=0;t<1e3;t++){const t=new c("cube",d,u,f);t.Transform.Position={X:e.Integer(innerWidth),Y:e.Integer(innerHeight)},t.getComponent(d).moveTo({X:e.Integer(innerWidth),Y:e.Integer(innerHeight)}),t.getComponent(d).onStart(((t,i)=>{t.Transform.rotateToPoint(i.Target),t.getComponent(u).drawByDotsCount(5,e.Integer(10,25)),t.getComponent(u).FillStyle={Color:"green"},t.getComponent(d).Speed=1,t.setLayer(g)})),t.getComponent(d).onFinish(((t,i)=>{t.getComponent(u).FillStyle={Color:"red"},t.setLayer(y),setTimeout((()=>{i.moveTo({X:e.Integer(innerWidth),Y:e.Integer(innerHeight)})}),2e3)})),g.addGameObject(t)}})(),p.showFps(!0),p.play(),document.body.addEventListener("keypress",(t=>{if("Spacebar"===t.key||" "===t.key){console.log("click");const t=g.Order;g.Order=y.Order,y.Order=t}}))})();